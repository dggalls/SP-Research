<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Mapbox Example</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <script src="bower_components/chartist/dist/chartist.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="bower_components/chartist/dist/chartist.min.css">

    <script src='https://api.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="./scripts/mapScripts.js"></script>
    <script src="./scripts/chartScripts.js"></script>
    <link href='./styles/styles.css' rel='stylesheet' />
</head>

<body>

<div id='map'></div>

<div class='map-overlay' id='features'>
    <div class="ct-chart ct-square" id="chart-2a"></div>
</div>

<div class='map-overlay' id='legend'>
    <div id="menu">
        <input type="radio" name="radValue" value="cjndbqgaf7ngz2soeasph8rnr" id="cjndbqgaf7ngz2soeasph8rnr" checked>
        <label for='cjndbqgaf7ngz2soeasph8rnr'>Year 1 Total Spending</label>
        <br>
        <input type="radio" name="radValue" value="cjndcs63k7otr2sp42lcd9o9w" id="cjndcs63k7otr2sp42lcd9o9w">
        <label for='cjndcs63k7otr2sp42lcd9o9w'>Year 2 Total Spending</label>
    </div>
</div>

<script>
    //Mapbox Access Token
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGdnYWxscyIsImEiOiJjam5kODhhODY1d2g5M3huMTN5ZTluOGRhIn0.T10MzeopQu-_6mXyp_zq_A';

    //Coordinates for flyTo method which takes you to a location (triggered when layering is changed)
    const amCoords = [-8.268010340029832, 53.49660773012667];

    //Initialise Map
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/dggalls/cjnekqlzr1x622rnu4kpc6ml2',
        center: [-74.50, 40], // starting position
        zoom: 4.1141377379312125 // starting zoom
    });


    var expression = ["match", ["get", "STATE"]];
    var initialData = [];
    var csvData;

    //Read CSV
    $(document).ready(function() {
        $.ajax({
            type: "GET",
            url: "./AMStates.csv",
            dataType: "text",
            success: function(data) {
                getCSVFloatColumnData('Y1', data, initialData);
                assignVectorColours(initialData);
                loadLayer();
                csvData = data;
            }
        });
    });

    //Functiionality for switching layer style
    var layerList = document.getElementById('menu');
    var inputs = layerList.getElementsByTagName('input');

    function switchLayer(layer) {
        var layerId = layer.target.id;
        var location = map.getStyle().name;

        if(location === 'americastates') {
            map.flyTo({
                center: amCoords,
                zoom: 6.6
            });
        } else {
            map.flyTo({
                center: ireCoords,
                zoom: 4.1
            });
        }
        map.setStyle('mapbox://styles/dggalls/' + layerId);
    }

    for (var i = 0; i < inputs.length; i++) {
        inputs[i].onclick = switchLayer;
    }

    var tempData2 = [];




    //Functionality for when a user clicks on a registered location
    map.on('click', function(e) {

        var features = map.queryRenderedFeatures(e.point, {
            layers: ['states-join']
        });

        if (!features.length) {
            return;
        }

        var feature = features[0];

        csvColumnData = [];
        tempData2 = [];

        var chartColumns = ['Y1', 'Y2', 'Y3', 'Y4', 'Y5'];
        var chartIndexes = ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5'];

        getChartData(chartColumns, csvData, tempData2, feature.properties.STATE);

        console.log(tempData2);

        //Popup function
        var popup = new mapboxgl.Popup({ offset: [0, -15] })
            .setLngLat(e.lngLat)
            .setHTML('<img src="img/Mastercard.png" style="width=140px; height:50px; margin:auto;"><br>' +
                '<h3>Location: '
                + feature.properties.NAME +
                '</h3><br>').addTo(map);


        generateChart(chartColumns, tempData2)


    });


</script>

</body>
</html>