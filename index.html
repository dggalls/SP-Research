<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Mapbox Example</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <script src="bower_components/chartist/dist/chartist.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="bower_components/chartist/dist/chartist.min.css">

    <script src='https://api.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="./scripts/mapScripts.js"></script>
    <script src="./scripts/chartScripts.js"></script>
    <script src="./scripts/generalScripts.js"></script>
    <script src="./scripts/maps.js"></script>


    <!--JQuery Slider-->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


    <link href='./styles/styles.css' rel='stylesheet' />
</head>

<body>

<div id='map'></div>

<div class='map-overlay' id='features'>
    <div class="ct-chart ct-square" id="chart-2a"></div>
</div>

<div class='map-overlay' id='data-switch'>
    <div id="menu">
        <input type="radio" name="yearValue" value="1" id="Y1" checked>
        <label for='Y1'>Year 1 Total Spending</label>
        <br>
        <input type="radio" name="yearValue" value="2" id="Y2">
        <label for='Y2'>Year 2 Total Spending</label>
        <br>
        <input type="radio" name="yearValue" value="3" id="Y3">
        <label for='Y3'>Year 3 Total Spending</label>
        <br>
        <input type="radio" name="yearValue" value="4" id="Y4">
        <label for='Y4'>Year 4 Total Spending</label>
        <br>
        <input type="radio" name="yearValue" value="5" id="Y5">
        <label for='Y5'>Year 5 Total Spending</label>

    </div>
</div>

<div class='map-overlay'></div>

<div class="map-overlay" id="legend">
    <div id="legend-text" style="text-align: center"></div>
    <hr>
</div>

<div class="map-overlay" id="filter">
    <p><input type="text" id="amount" readonly style="border:0; color:#f6931f; font-weight:bold;"></p>
    <div id="slider-range">
    </div>

</div>


<script>
    //Mapbox Access Token
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGdnYWxscyIsImEiOiJjam5kODhhODY1d2g5M3huMTN5ZTluOGRhIn0.T10MzeopQu-_6mXyp_zq_A';

    //Coordinates for flyTo method which takes you to a location (triggered when layering is changed)
    const amCoords = [-8.268010340029832, 53.49660773012667];

    //Initialise Map
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/dggalls/cjnekqlzr1x622rnu4kpc6ml2',
        center: [-74.50, 40], // starting position
        zoom: 4.1141377379312125 // starting zoom
    });


    var expression = ["match", ["get", "STATE"]];
    var expression2 = ["match", ["get", "COUNTY"]];
    var initialData = [];
    var initialData2 = [];

    var stateCsvData;
    var zipCsvData;
    var currentLayer = 'states';

    // Read CSV
    $(document).ready(function() {
        $.ajax({
            type: "GET",
            url: "./AMStates.csv",
            dataType: "text",
            success: function(data) {
                getCSVFloatColumnData('Y1', data, initialData, "State");
                assignVectorColours(initialData, expression, "STATE", 'states');
                stateCsvData = data;
            }
        });
    });

    $(document).ready(function() {
        $.ajax({
            type: "GET",
            url: "./AMCounties.csv",
            dataType: "text",
            success: function(data) {
                getCSVFloatColumnData('Y1', data, initialData2, "State");
                assignVectorColours(initialData2, expression2, "STATE", 'counties');
                zipCsvData = data;
                loadLayer();
            }
        });
    });

    //Functiionality for switching layer style
    var layerList = document.getElementById('menu');
    var inputs = layerList.getElementsByTagName('input');

    for (var i = 0; i < inputs.length; i++) {
        inputs[i].onclick = switchLayer;
    }

    map.on('zoom', function() {
        var chartName = document.getElementById("chart-name");

        if(map.getZoom() >= 7 && map.getLayer('states-join').visibility === 'visible') {
            map.setLayoutProperty('states-join', 'visibility', 'none');
            map.setLayoutProperty('zip-join', 'visibility', 'visible');
            currentLayer = 'counties';

            var legendDiv = document.getElementById('legend');
            legendDiv.innerHTML = '';
            addLegend('counties');

        } else if (map.getZoom() < 7 && map.getLayer('states-join').visibility === 'none'){
            map.setLayoutProperty('states-join', 'visibility', 'visible');
            map.setLayoutProperty('zip-join', 'visibility', 'none');
            currentLayer = 'states';

            addLegend('states');
        }
    });

    var tempData2 = [];

    var chartColumns = ['Y1', 'Y2', 'Y3', 'Y4', 'Y5'];
    var layerId;
    var hideClick = false;
    var filters = [];

    //Functionality for when a user clicks on a registered location
    map.on('click', function(e) {


        csvColumnData = [];
        tempData2 = [];


        if(currentLayer === 'states') {
            var features = map.queryRenderedFeatures(e.point, { layers: ['states-join'] });
            layerId = 'states-join';
        } else {
            var features = map.queryRenderedFeatures(e.point, { layers: ['zip-join'] });
            layerId = 'zip-join';
        }

        if (!features.length) {
            return;
        }
        var feature = features[0];

        filters = [];
        findLocationNamesBetweenValues(initialData, filters, $("#slider-range").slider("values", 0), $("#slider-range").slider("values", 1));
        console.log(filters);

        if(hideClick) {
            map.setFilter(layerId, ['match', ['get', 'STATE'], filters, true, false])
        }
        generatePopup(chartColumns, feature, feature.properties.NAME, e);
    });


</script>

</body>
</html>